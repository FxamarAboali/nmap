NSOCK_VERSION = 0.02
prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = @bindir@
sbindir = @sbindir@
mandir = @mandir@
srcdir = @srcdir@
datarootdir = @datarootdir@

CC = @CC@
AR = ar
RANLIB = @RANLIB@
CCOPT = 
DEFS = @DEFS@ -DNSOCK_VERSION=\"$(NSOCK_VERSION)\"
# With GCC, add extra security checks to source code.
DEFS += -D_FORTIFY_SOURCE=2
INCLS = -I$(srcdir)/../include
CFLAGS = @CFLAGS@ $(CCOPT)
# CFLAGS = -g -Wall $(DEFS) $(INCLS)
CPPFLAGS = @CPPFLAGS@ $(DEFS) $(INCLS)
STATIC = 
SHTOOL = ./shtool
INSTALL = $(SHTOOL) install 
MAKEDEPEND = @MAKEDEPEND@
RPMTDIR=$(HOME)/rpmdir
NBASEDIR=@NBASEDIR@
NSOCKTESTDIR=@NSOCKTESTDIR@

TARGET = libnsock.a

SRCS = 	$(srcdir)/error.c $(srcdir)/filespace.c $(srcdir)/gh_heap.c $(srcdir)/nsock_connect.c $(srcdir)/nsock_core.c \
	$(srcdir)/nsock_iod.c $(srcdir)/nsock_read.c $(srcdir)/nsock_timers.c $(srcdir)/nsock_write.c \
	$(srcdir)/nsock_ssl.c $(srcdir)/nsock_event.c $(srcdir)/nsock_pool.c $(srcdir)/netutils.c $(srcdir)/nsock_pcap.c \
	$(srcdir)/nsock_engines.c $(srcdir)/engine_select.c $(srcdir)/engine_epoll.c $(srcdir)/engine_kqueue.c \
	$(srcdir)/engine_poll.c $(srcdir)/nsock_proxy.c $(srcdir)/nsock_log.c $(srcdir)/proxy_http.c $(srcdir)/proxy_socks4.c

OBJS =	error.o filespace.o gh_heap.o nsock_connect.o nsock_core.o \
	nsock_iod.o nsock_read.o nsock_timers.o nsock_write.o \
	nsock_ssl.o nsock_event.o nsock_pool.o netutils.o nsock_pcap.o \
	nsock_engines.o engine_select.o engine_epoll.o engine_kqueue.o \
	engine_poll.o nsock_proxy.o nsock_log.o proxy_http.o proxy_socks4.o

DEPS =	$(srcdir)/error.h $(srcdir)/filespace.h $(srcdir)/gh_list.h $(srcdir)/nsock_internal.h $(srcdir)/netutils.h $(srcdir)/nsock_pcap.h \
	$(srcdir)/nsock_log.h $(srcdir)/nsock_proxy.h $(srcdir)/gh_heap.h $(srcdir)/../include/nsock.h \
	$(NBASEDIR)/libnbase.a

%.o: $(srcdir)/%.c $(DEPS)
	$(CC) -c $(CPPFLAGS) $(CFLAGS) $< -o $@

all: $(TARGET) 

$(TARGET): $(DEPS) $(OBJS)
	rm -f $@
	$(AR) cr $@ $(OBJS)
	$(RANLIB) $@

$(NBASEDIR)/libnbase.a: $(NBASEDIR)/Makefile
	cd $(NBASEDIR) && $(MAKE)

clean-test:
	cd $(NSOCKTESTDIR) && $(MAKE) clean

clean: clean-test
	rm -f $(OBJS) $(TARGET)

distclean: clean
	rm -f Makefile makefile.dep config.log config.status $(srcdir)/../include/nsock_config.h $(NSOCKTESTDIR)/Makefile

depend:
	$(MAKEDEPEND) $(INCLS) -s "# DO NOT DELETE" -- $(DEFS) -- $(SRCS)

check:
	cd $(NSOCKTESTDIR) && $(MAKE) && ./run_tests.sh

${srcdir}/configure: $(srcdir)/configure.ac 
	cd ${srcdir} && autoconf

# autoheader might not change config.h.in, so touch a stamp file.
${srcdir}/config.h.in: stamp-h.in
${srcdir}/stamp-h.in: $(srcdir)/configure.ac acconfig.h \
	config.h.top config.h.bot
	cd ${srcdir} && autoheader
	echo timestamp > ${srcdir}/stamp-h.in

config.h: stamp-h
stamp-h: config.h.in config.status
	./config.status

Makefile: $(srcdir)/Makefile.in config.status
	./config.status

config.status: $(srcdir)/configure
	./config.status --recheck

makefile.dep:
	$(CC) -MM $(CPPFLAGS) $(SRCS) > $@
-include makefile.dep